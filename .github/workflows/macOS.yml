name: macOS build

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  boinc_ref: 82d0a3731c743884b6e7a25d68c6558eca691635  # client release 7.20.2
  gwnum_ver: "v3019b21"
  MACOSX_DEPLOYMENT_TARGET: "10.14"

jobs:
  boinc-macIntel64:
    runs-on: macos-13

    steps:
      - name: Cache BOINC libs
        id: cache-boinc-macIntel64
        uses: actions/cache@v3
        with:
          path: |
            boinc/mac_build/build/Deployment
            boinc/*.*
            boinc/api
            boinc/lib
          key: boinc-${{ runner.os }}-${{ env.boinc_ref }}-macIntel64

      - uses: maxim-lobanov/setup-xcode@v1
        if: steps.cache-boinc-macIntel64.outputs.cache-hit != 'true'
        with:
          xcode-version: '15.2.0'

      - name: Checkout boinc
        if: steps.cache-boinc-macIntel64.outputs.cache-hit != 'true'
        uses: actions/checkout@v3
        with:
          repository: 'BOINC/boinc'
          ref: ${{ env.boinc_ref }}
          path: 'boinc'

      - name: build boinc
        if: steps.cache-boinc-macIntel64.outputs.cache-hit != 'true'
        run: |
          cd ./boinc/mac_build/
          source BuildMacBOINC.sh -lib

  gwnum:
    runs-on: macos-13

    steps:
      - name: Cache gwnum.a libs
        id: cache-gwnum-macIntel64
        uses: actions/cache@v3
        with:
          path: |
            gwnum/gwnum.a
            gwnum/polymult.a
          key: gwmum-${{ runner.os }}-${{ env.gwnum_ver }}-macIntel64

      - name: Download p95
        if: steps.cache-gwnum-macIntel64.outputs.cache-hit != 'true'
        run: wget "https://www.mersenne.org/download/software/v30/30.19/p95${{ env.gwnum_ver }}.source.zip"

      - name: unzip p95
        if: steps.cache-gwnum-macIntel64.outputs.cache-hit != 'true'
        run: unzip p95*.zip

      - name: build gwnum.a and polymult.a
        if: steps.cache-gwnum-macIntel64.outputs.cache-hit != 'true'
        run: |
          cd gwnum
          make -f makemac -j gwnum.a polymult.a

  macIntel64:
    needs: [boinc-macIntel64, gwnum]
    runs-on: macos-13
    env:
      SDKROOT: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk
      LIBCXX_INCLUDE: /opt/libcxx-11/include/c++/v1

    steps:
      - name: Use cached BOINC libs
        id: cache-boinc
        uses: actions/cache@v3
        with:
          path: |
            boinc/mac_build/build/Deployment
            boinc/*.*
            boinc/api
            boinc/lib
          key: boinc-${{ runner.os }}-${{ env.boinc_ref }}-macIntel64
          fail-on-cache-miss: true

      - name: Use cached gwnum
        id: cache-gwnum
        uses: actions/cache@v3
        with:
          path: |
            gwnum/gwnum.a
            gwnum/polymult.a
          key: gwmum-${{ runner.os }}-${{ env.gwnum_ver }}-macIntel64
          fail-on-cache-miss: true

      - name: setup MacOSX10.14 SDK
        run: |
          wget https://github.com/phracker/MacOSX-SDKs/releases/download/11.3/MacOSX10.14.sdk.tar.xz
          xz -c -d MacOSX10.14.sdk.tar.xz | tar -xf -
          sudo mv MacOSX10.14.sdk "$SDKROOT"
          sudo /usr/libexec/PlistBuddy -c "Set :MinimumSDKVersion 10.14" /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist

      - name: install deps (brew)
        run: brew install gmp

      - name: install llvm headers
        run: |
          curl -LO https://github.com/llvm/llvm-project/releases/download/llvmorg-11.0.1/libcxx-11.0.1.src.tar.xz
          tar -xf libcxx-11.0.1.src.tar.xz
          sudo mkdir -p "$LIBCXX_INCLUDE"
          sudo cp -R libcxx-11.0.1.src/include/* "$LIBCXX_INCLUDE"

      - name: remove dylib files (force static link)
        run: |
          rm -f /usr/local/opt/libomp/lib/libomp.dylib
          rm -f /usr/local/opt/gmp/lib/libgmp.dylib

      - name: Checkout prst
        uses: actions/checkout@v3
        with:
          submodules: 'true'
          path: 'prst'

      - name: copy gwnum
        run: cp gwnum/gwnum.a prst/framework/gwnum/mac64/

      - name: make
        run: cd prst/src/mac64 && make -j

      - name: make (boinc)
        run: cd prst/src/mac64 && make -f Makefile.boinc -j

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macIntel64_bins
          path: |
            prst/src/mac64/prst
            prst/src/mac64/prst_boinc
            gwnum
